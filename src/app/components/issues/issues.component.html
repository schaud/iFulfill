<div class="container">
  <div *ngIf="showSpinner" class="spinner-container">
    <mat-spinner color="accent"></mat-spinner>
  </div>

  <mat-accordion
    displayMode="flat"
    class="mat-table"
    name="pnlIssues"
    (click)="$event.stopPropagation()"
    (enter)="$event.stopPropagation()"
  >
    <section>
      <div id="dvFunctions">
        <span>
          <form class="search-bar">
            <mat-form-field
              style="width: 350px; height: 65px; margin-top: -15px"
            >
              <mat-label class="search-lbl">
                <mat-icon
                  svgIcon="search"
                  style="width: 25px; height: 26px; vertical-align: middle"
                >
                </mat-icon>
                <span style="vertical-align: middle"> Search for Issues</span>
              </mat-label>
              <input
                class="searchInput"
                (keyup)="applyFilter($event.target.value)"
                name="search"
                matInput
              />
            </mat-form-field>
          </form>
        </span>
        <span class="spacer"></span>
        <button mat-raised-button color="primary" (click)="openNewDialog()">
          <mat-icon svgIcon="add_icon"></mat-icon>
          <span>New Issue</span>
        </button>
        <button
          [disabled]="!hasSelected"
          mat-raised-button
          color="primary"
          (click)="openEditDialog()"
        >
          <mat-icon svgIcon="edit_selected"></mat-icon>
          <span>Edit Selected Issues </span>
        </button>
      </div>
    </section>
    <section
      #issueSort
      matSort
      (matSortChange)="sortIssues($event, issues)"
      class="mat-elevation-z2 mat-header-row"
    >
      <mat-checkbox
        class="headercheckbox"
        #chkAll
        id="chkAll"
        name="chkAll"
        [(ngModel)]="isChecked"
        [(indeterminate)]="indeterminate"
        (change)="selectAll($event)"
      >
      </mat-checkbox>
      <span class="mat-header-cell id" mat-sort-header="sr">SR#</span>
      <span class="mat-header-cell" mat-sort-header="title">Title</span>
      <span class="mat-header-cell" mat-sort-header="reported_at"
        >Reported Date</span
      >

      <span class="mat-header-cell" mat-sort-header="status">Status</span>
      <span class="mat-header-cell" mat-sort-header="criticality"
        >Criticality</span
      >
      <span class="mat-header-cell" mat-sort-header="reported_by"
        >Reporter</span
      >
    </section>
    <ng-container name="mainContainer" #mainContainer id="mainContainer">
      <mat-expansion-panel
        #pnlIssues
        name="pnlIssues"
        *ngFor="let issue of currentItemsToShow; let i = index"
        (afterExpand)="selectedIssue = issue"
        (afterCollapse)="issue.expanded = false; isNewMode = false"
      >
        <mat-expansion-panel-header class="expansion-container">
          <mat-panel-title class="expansion-child id">
            <mat-checkbox
              name="chkEdit"
              (click)="$event.stopPropagation()"
              (change)="selectItem($event, i)"
              [checked]="issue.checked"
            ></mat-checkbox>
            {{ issue.sr }}
          </mat-panel-title>
          <mat-panel-title class="expansion-child">
            {{ issue.title }}
          </mat-panel-title>
          <mat-panel-title class="expansion-child">
            {{ issue.reported_at }}
          </mat-panel-title>

          <mat-panel-title class="expansion-child">
            {{ resolveStatus(issue.status) }}
          </mat-panel-title>
          <mat-panel-title class="expansion-child">
            {{ resolveCriticality(issue.criticality) }}
          </mat-panel-title>
          <mat-panel-title class="expansion-child">
            {{ issue.reported_by }}
          </mat-panel-title>
        </mat-expansion-panel-header>
        <div id="subdiv">
          <div class="dataRowfirst">
            <div>
              <strong> ID#: </strong>
              <span class="data">{{ issue.id }}</span>
            </div>
            <div>
              <strong> Target Date :</strong>
              <span class="data">{{ issue.target_date }}</span>
            </div>
            <div>
              <strong> Closure date :</strong>
              <span class="data">{{ issue.closure_date }}</span>
            </div>
          </div>
          <div class="dataRow">
            <div>
              <strong> Verified By :</strong>
              <span class="data">{{ issue.verified_by }}</span>
            </div>
            <div>
              <strong> Pending With : </strong>
              <span class="data">{{ issue.pending_with }}</span>
            </div>
          </div>

          <div class="task-details">
            <strong style="margin-right: 5px; vertical-align: top">
              Description :</strong
            >
            <textarea
              readonly="true"
              style="display: inline; clear: left; margin-top: 6px !important"
              cols="100"
              rows="6"
              >{{ issue.description }}</textarea
            >
          </div>

          <div class="remaks" (click)="$event.stopPropagation()">
            <div id="remarkButtons">
              <strong>Rmarks :</strong>
              <mat-icon
                *ngIf="!isNewMode"
                id="btnAddRemark"
                svgIcon="add"
                title="add"
                (click)="$event.stopPropagation()"
                (click)="showAddRemark(issue)"
              ></mat-icon>

              <mat-icon
                *ngIf="isNewMode"
                id="btnCancelRemark"
                svgIcon="cancel"
                title="Cancel"
                (click)="$event.stopPropagation()"
                (click)="cancelAddRemark(issue.id)"
              ></mat-icon>
              <mat-icon
                *ngIf="isNewMode"
                id="btnSaveRemark"
                svgIcon="save"
                title="Save"
                (click)="$event.stopPropagation()"
                (click)="addRemark(issue, remarkTxt)"
              ></mat-icon>
            </div>
            <ul
              (click)="$event.stopPropagation()"
              name="ulRemarks"
              #ulRemarks
              style="padding: 0px !important ; left: 0px !important"
              ngDefaultControl
            >
              <div
                (click)="$event.stopPropagation()"
                style="
                  display: table;
                  padding: 0px !important ;
                  left: 0px !important;
                "
                #remarklst
                name="remarklst"
                *ngFor="
                  let r of issue.remarks;
                  let i = index;
                  first as isFirst;
                  last as isLast
                "
              >
                <li
                  *ngIf="isFirst && issue.expanded && isNewMode"
                  (click)="$event.stopPropagation()"
                >
                  <form #frmAddRemark id="frmAddRemark" name="frmAddRemark">
                    <div>
                      <img src="/assets/person-circle-outline.svg" [alt]="" />
                      <strong
                        style="
                          font-family: sans-serif;
                          font-weight: bolder;
                          color: chocolate;
                        "
                        >You</strong
                      >

                      <small
                        class="data"
                        style="font-family: sans-serif; font-weight: bolder"
                        >{{ " on " + getCurrentDate() }}</small
                      >

                      <textarea
                        (click)="$event.stopPropagation()"
                        class="remarkArea"
                        #txtNewRemark
                        name="txtNewRemark"
                        [(ngModel)]="remarkTxt"
                        matInput
                        placeholder="Type your remark here .."
                      ></textarea>
                    </div>
                  </form>
                </li>
                <li>
                  <span *ngIf="r.user_id" style="padding: 0px !important">
                    <img src="/assets/person-circle-outline.svg" [alt]="" />
                    <strong>{{ getUserById(r.user_id).fname }}</strong>
                    <small *ngIf="r.created_at" class="data"
                      >{{ " on " + r.created_at }}
                    </small>
                  </span>

                  <br />
                  <samp *ngIf="r.remark"> {{ r.remark }}</samp>
                </li>
              </div>
            </ul>
          </div>
        </div>
        <!-- <button
          style="margin-left: 25px"
          mat-raised-button
          color="primary"
          (click)="openTasksDialog()"
        >
          View Subtasks
        </button>
        <button
          style="margin-left: 25px"
          mat-raised-button
          color="primary"
          (click)="openDialog()"
        >
          Add a Subtask
        </button> -->
      </mat-expansion-panel>
    </ng-container>
  </mat-accordion>
  <p
    *ngIf="issues.length === 0"
    style="margin-left: auto; margin-right: auto; width: fit-content"
  >
    No issue have been posted .
  </p>

  <mat-paginator
    #paginator
    (page)="onPageChange($event)"
    [length]="dataSource?.data.length"
    [pageIndex]="0"
    [pageSize]="pageSize"
    [pageSizeOptions]="[1, 3, 5]"
  >
  </mat-paginator>
</div>
